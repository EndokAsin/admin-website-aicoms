<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - AICOMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .form-label { @apply block text-sm font-medium text-gray-700; }
        .form-input { @apply mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm; }
        .btn { @apply inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white transition-colors duration-200; }
        .btn-red { @apply bg-red-600 hover:bg-red-700; }
        .btn-green { @apply bg-green-600 hover:bg-green-700; }
        .btn-blue { @apply bg-blue-600 hover:bg-blue-700; }
        .btn-gray { @apply bg-gray-500 hover:bg-gray-600; }
        .notification { @apply fixed top-5 right-5 w-auto max-w-sm p-4 rounded-lg shadow-lg text-white transform translate-x-full transition-transform duration-300 ease-out z-50; }
        .notification.show { @apply translate-x-0; }
        .tag-container { @apply flex flex-wrap gap-2 p-2 border border-gray-200 rounded-md min-h-[42px] bg-gray-50; }
        .tag-item { @apply flex items-center bg-red-100 text-red-800 text-sm font-medium px-3 py-1 rounded-full; }
        .tag-delete { @apply ml-2 w-4 h-4 text-red-600 hover:text-red-800 cursor-pointer; }
        .admin-tab-button.active { @apply bg-red-600 text-white border-red-600; }
        .admin-tab-button { @apply -mb-px px-4 py-2 text-sm font-medium text-gray-600 bg-transparent border-b-2 border-transparent rounded-t-lg hover:text-red-600 hover:border-gray-300; }
        .admin-tab-panel { @apply hidden; }
        .admin-tab-panel.active { @apply block; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="notification-container"></div>

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Admin Panel AICOMS</h1>
            <p class="text-gray-600">Pilih tab di bawah untuk mengelola konten.</p>
        </div>

        <div class="mb-4 border-b border-gray-200">
            <nav id="admin-tabs" class="flex flex-wrap" aria-label="Tabs">
                <button data-tab="anggota" class="admin-tab-button active">Kelola Anggota</button>
                <button data-tab="berita" class="admin-tab-button">Kelola Berita</button>
                <button data-tab="proyek" class="admin-tab-button">Kelola Proyek</button>
                <button data-tab="tags" class="admin-tab-button">Kelola Tags</button>
            </nav>
        </div>

        <div id="main-content">
            <div id="panel-anggota" class="admin-tab-panel active"></div>
            <div id="panel-berita" class="admin-tab-panel"></div>
            <div id="panel-proyek" class="admin-tab-panel"></div>
            <div id="panel-tags" class="admin-tab-panel"></div>
        </div>
    </div>

    <script type="module">
        const SUPABASE_URL = 'https://ostoxfgxxjfbvfouydiv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9zdG94Zmd4eGpmYnZmb3V5ZGl2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2OTI1MzcsImV4cCI6MjA2NzI2ODUzN30.PqEWjFaTGZZmQ5o2rNmv2G34k1-UKfloU_ETDxhwcro';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- GENERAL ---
        const notificationContainer = document.getElementById('notification-container');
        function showNotification(message, type = 'success') {
            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            const notification = document.createElement('div');
            notification.className = `notification ${bgColor}`;
            notification.textContent = message;
            notificationContainer.appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 10);
            setTimeout(() => { notification.classList.remove('show'); setTimeout(() => notification.remove(), 300); }, 4000);
        }

        function addTagToContainer(containerId, value) {
            if (!value.trim()) return;
            const container = document.getElementById(containerId);
            const tag = document.createElement('div');
            tag.className = 'tag-item';
            tag.innerHTML = `<span class="tag-text">${value.trim()}</span><svg class="tag-delete" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>`;
            tag.querySelector('.tag-delete').addEventListener('click', () => tag.remove());
            container.appendChild(tag);
        }
        
        function getTagsFromContainer(containerId) {
            return Array.from(document.querySelectorAll(`#${containerId} .tag-text`)).map(tag => tag.textContent);
        }

        // --- RENDER & INIT ---
        document.addEventListener('DOMContentLoaded', initializeAdminPanel);

        async function initializeAdminPanel() {
            const { error } = await supabase.from('anggota').select('id', { count: 'exact', head: true });
            if (error && (error.message.includes("Invalid API key") || error.message.includes("401"))) {
                document.getElementById('main-content').innerHTML = `
                    <div class="col-span-full text-center bg-red-50 border border-red-200 p-6 rounded-lg">
                        <p class="font-bold text-red-600 text-lg">Konfigurasi API Key Tidak Valid</p>
                        <p class="mt-2 text-gray-700">Kunci API yang Anda gunakan salah atau sudah tidak berlaku. Silakan buat kunci baru.</p>
                        <div class="mt-4 text-sm text-left">
                            <p class="font-semibold text-gray-800">Langkah-langkah Perbaikan:</p>
                            <ol class="list-decimal list-inside mt-2 space-y-1 text-gray-600">
                                <li>Buka dashboard Supabase proyek Anda.</li>
                                <li>Pergi ke <strong>Project Settings</strong> (ikon gerigi).</li>
                                <li>Pilih menu <strong>API</strong>.</li>
                                <li>Di bawah <strong>Project API Keys</strong>, klik <strong>"Generate new key"</strong> untuk kunci <strong><code>anon</code></strong>.</li>
                                <li>Salin kunci yang baru dan tempelkan ke variabel <strong><code>SUPABASE_ANON_KEY</code></strong> di dalam kode ini.</li>
                            </ol>
                        </div>
                    </div>
                `;
                return;
            }
            renderAnggotaPanel();
            renderBeritaPanel();
            renderProyekPanel();
            renderTagsPanel();
            setupTabLogic();
            setupAnggotaLogic();
            setupBeritaLogic();
            setupProyekLogic();
            setupTagsLogic();
            
            fetchAnggota();
            fetchBerita();
            fetchProyek();
            fetchTags();
        }

        function setupTabLogic() {
            const tabButtons = document.querySelectorAll('.admin-tab-button');
            const tabPanels = document.querySelectorAll('.admin-tab-panel');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabPanels.forEach(panel => panel.classList.remove('active'));
                    button.classList.add('active');
                    document.getElementById(`panel-${button.dataset.tab}`).classList.add('active');
                });
            });
        }

        // --- ANGGOTA PANEL ---
        function renderAnggotaPanel() {
            document.getElementById('panel-anggota').innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div id="anggota-form-card" class="lg:col-span-1 bg-white p-6 rounded-lg shadow-md">
                        <h2 id="anggota-form-title" class="text-xl font-bold mb-4">Tambah Anggota Baru</h2>
                        <form id="anggota-form" class="space-y-6"></form>
                    </div>
                    <div class="lg:col-span-2 space-y-8">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-xl font-bold mb-4">Unggah Anggota dari CSV</h2>
                            <div class="flex items-center space-x-4"><input type="file" id="anggota-csv-file" accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-50 file:text-red-700 hover:file:bg-red-100"/><button id="anggota-upload-csv-button" class="btn btn-blue flex-shrink-0">Unggah</button></div>
                        </div>
                        <div class="bg-white rounded-lg shadow-md">
                            <div class="p-6 border-b"><h2 class="text-xl font-bold">Daftar Anggota</h2></div>
                            <div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Anggota</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Jabatan</th><th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Aksi</th></tr></thead><tbody id="anggota-table-body"></tbody></table></div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('anggota-form').innerHTML = `
                <input type="hidden" id="anggota-id"><input type="hidden" id="anggota-existing-foto-url">
                <div><label class="form-label">Foto Profil</label><div class="mt-1 flex items-center space-x-4"><img id="anggota-foto-preview" src="https://placehold.co/100x100/EFEFEF/AAAAAA?text=Foto" class="w-24 h-24 rounded-full object-cover bg-gray-100"><input type="file" id="anggota-foto-upload" accept="image/*" class="hidden"><button type="button" onclick="document.getElementById('anggota-foto-upload').click()" class="btn bg-white text-gray-700 border border-gray-300 hover:bg-gray-50">Ganti</button></div></div>
                <div><label for="anggota-nama" class="form-label">Nama Lengkap</label><input type="text" id="anggota-nama" class="form-input" required></div>
                <div><label for="anggota-jabatan" class="form-label">Jabatan</label><input type="text" id="anggota-jabatan" class="form-input"></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="anggota-prodi" class="form-label">Program Studi</label><input type="text" id="anggota-prodi" class="form-input"></div><div><label for="anggota-universitas_asal" class="form-label">Universitas Asal</label><input type="text" id="anggota-universitas_asal" class="form-input"></div></div>
                <div><label class="form-label">Pendidikan</label><div id="anggota-pendidikan-container" class="tag-container"></div><input type="text" id="anggota-pendidikan-input" class="form-input" placeholder="Ketik lalu tekan Enter"></div>
                <div><label class="form-label">Topik Penelitian</label><div id="anggota-topik_penelitian-container" class="tag-container"></div><input type="text" id="anggota-topik_penelitian-input" class="form-input" placeholder="Ketik lalu tekan Enter"></div>
                <div><label class="form-label">Publikasi</label><div id="anggota-publikasi-container" class="tag-container"></div><input type="text" id="anggota-publikasi-input" class="form-input" placeholder="Ketik lalu tekan Enter"></div>
                <div class="flex items-center space-x-4 pt-4 border-t"><button type="submit" id="anggota-submit-button" class="btn btn-red w-full">Simpan Anggota</button><button type="button" id="anggota-cancel-edit-button" class="btn btn-gray hidden">Batal</button></div>
            `;
        }
        
        async function fetchAnggota() {
            const tableBody = document.getElementById('anggota-table-body');
            tableBody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-500">Memuat data...</td></tr>';
            const { data, error } = await supabase.from('anggota').select('*').order('nama', { ascending: true });
            if (error) return tableBody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-red-500">Gagal memuat data.</td></tr>';
            
            tableBody.innerHTML = '';
            data.forEach(member => {
                const row = `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap"><div class="flex items-center"><div class="flex-shrink-0 h-10 w-10"><img class="h-10 w-10 rounded-full object-cover" src="${member.foto_url || 'https://placehold.co/40x40/EFEFEF/AAAAAA?text=N/A'}" alt=""></div><div class="ml-4"><div class="text-sm font-medium text-gray-900">${member.nama}</div></div></div></td>
                        <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-500">${member.jabatan || ''}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2"><button class="text-green-600 hover:text-green-900" onclick="editAnggota(${member.id})">Edit</button><button class="text-red-600 hover:text-red-900" onclick="deleteAnggota(${member.id})">Hapus</button></td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }

        function setupAnggotaLogic() {
            const form = document.getElementById('anggota-form');
            const formCard = document.getElementById('anggota-form-card');
            const formTitle = document.getElementById('anggota-form-title');
            const submitButton = document.getElementById('anggota-submit-button');
            const cancelBtn = document.getElementById('anggota-cancel-edit-button');
            const fotoUpload = document.getElementById('anggota-foto-upload');
            const fotoPreview = document.getElementById('anggota-foto-preview');
            const idInput = document.getElementById('anggota-id');
            const existingFotoUrlInput = document.getElementById('anggota-existing-foto-url');

            const resetForm = () => {
                form.reset();
                idInput.value = '';
                existingFotoUrlInput.value = '';
                fotoPreview.src = 'https://placehold.co/100x100/EFEFEF/AAAAAA?text=Foto';
                formTitle.innerText = 'Tambah Anggota Baru';
                submitButton.innerText = 'Simpan Anggota';
                submitButton.classList.replace('btn-green', 'btn-red');
                formCard.classList.remove('bg-green-50');
                cancelBtn.classList.add('hidden');
                ['anggota-pendidikan', 'anggota-topik_penelitian', 'anggota-publikasi'].forEach(key => {
                    document.getElementById(`${key}-container`).innerHTML = '';
                });
            };

            window.editAnggota = async (id) => {
                const { data, error } = await supabase.from('anggota').select('*').eq('id', id).single();
                if (error) return showNotification("Gagal mengambil data", "error");
                
                resetForm();
                formTitle.innerText = 'Edit Anggota';
                submitButton.innerText = 'Update Anggota';
                submitButton.classList.replace('btn-red', 'btn-green');
                formCard.classList.add('bg-green-50');

                idInput.value = data.id;
                existingFotoUrlInput.value = data.foto_url || '';
                fotoPreview.src = data.foto_url || 'https://placehold.co/100x100/EFEFEF/AAAAAA?text=Foto';

                ['nama', 'jabatan', 'prodi', 'universitas_asal'].forEach(field => {
                    document.getElementById(`anggota-${field}`).value = data[field] || '';
                });
                
                ['pendidikan', 'topik_penelitian', 'publikasi'].forEach(key => {
                    if (Array.isArray(data[key])) data[key].forEach(item => addTagToContainer(`anggota-${key}-container`, item));
                });

                cancelBtn.classList.remove('hidden');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            window.deleteAnggota = async (id) => {
                if (!confirm('Yakin ingin menghapus anggota ini?')) return;
                const { data, error } = await supabase.from('anggota').delete().eq('id', id).select().single();
                if (error) return showNotification(`Gagal menghapus: ${error.message}`, 'error');
                
                if (data && data.foto_url) {
                    const path = new URL(data.foto_url).pathname.split('/foto-anggota/')[1];
                    await supabase.storage.from('foto-anggota').remove([path]);
                }
                showNotification('Anggota berhasil dihapus.', 'success');
                fetchAnggota();
            };

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = idInput.value;
                submitButton.disabled = true;
                submitButton.textContent = 'Menyimpan...';

                let fotoUrl = existingFotoUrlInput.value;
                const file = fotoUpload.files[0];

                if (file) {
                    const fileName = `anggota/${Date.now()}-${file.name}`;
                    const { error: uploadError } = await supabase.storage.from('foto-anggota').upload(fileName, file);
                    if (uploadError) {
                        showNotification(`Gagal unggah foto: ${uploadError.message}`, 'error');
                        submitButton.disabled = false;
                        submitButton.textContent = id ? 'Update Anggota' : 'Simpan Anggota';
                        return;
                    }
                    const { data: urlData } = supabase.storage.from('foto-anggota').getPublicUrl(fileName);
                    fotoUrl = urlData.publicUrl;
                }
                
                const memberData = {
                    nama: document.getElementById('anggota-nama').value,
                    jabatan: document.getElementById('anggota-jabatan').value,
                    prodi: document.getElementById('anggota-prodi').value,
                    universitas_asal: document.getElementById('anggota-universitas_asal').value,
                    foto_url: fotoUrl,
                    pendidikan: getTagsFromContainer('anggota-pendidikan-container'),
                    topik_penelitian: getTagsFromContainer('anggota-topik_penelitian-container'),
                    publikasi: getTagsFromContainer('anggota-publikasi-container'),
                };

                const { error } = id ? await supabase.from('anggota').update(memberData).eq('id', id) : await supabase.from('anggota').insert([memberData]);
                if (error) showNotification(`Gagal simpan: ${error.message}`, 'error');
                else {
                    showNotification('Data anggota berhasil disimpan!', 'success');
                    resetForm();
                    fetchAnggota();
                }
                submitButton.disabled = false;
                submitButton.textContent = id ? 'Update Anggota' : 'Simpan Anggota';
            });

            cancelBtn.addEventListener('click', resetForm);
            fotoUpload.addEventListener('change', (e) => { if (e.target.files[0]) fotoPreview.src = URL.createObjectURL(e.target.files[0]); });
            ['pendidikan', 'topik_penelitian', 'publikasi'].forEach(key => {
                const input = document.getElementById(`anggota-${key}-input`);
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addTagToContainer(`anggota-${key}-container`, input.value);
                        input.value = '';
                    }
                });
            });
        }

        // --- BERITA PANEL ---
        function renderBeritaPanel() {
            document.getElementById('panel-berita').innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div id="berita-form-card" class="lg:col-span-1 bg-white p-6 rounded-lg shadow-md">
                        <h2 id="berita-form-title" class="text-xl font-bold mb-4">Tambah Berita Baru</h2>
                        <form id="berita-form" class="space-y-6">
                            <input type="hidden" id="berita-id"><input type="hidden" id="berita-existing-gambar-url">
                            <div><label class="form-label">Gambar Berita</label><div class="mt-1"><img id="berita-gambar-preview" src="https://placehold.co/600x400/EFEFEF/AAAAAA?text=Gambar" class="w-full h-40 object-cover bg-gray-100 rounded"><input type="file" id="berita-gambar-upload" accept="image/*" class="hidden"><button type="button" onclick="document.getElementById('berita-gambar-upload').click()" class="mt-2 btn bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 w-full">Pilih Gambar</button></div></div>
                            <div><label for="berita-judul" class="form-label">Judul Berita</label><input type="text" id="berita-judul" class="form-input" required></div>
                            <div><label for="berita-tanggal" class="form-label">Tanggal</label><input type="date" id="berita-tanggal" class="form-input" required></div>
                            <div><label for="berita-isi" class="form-label">Isi Berita</label><textarea id="berita-isi" rows="8" class="form-input"></textarea></div>
                            <div><label class="form-label">Pilih Tags</label><div id="berita-tags-checkbox-container" class="mt-2 space-y-2 max-h-40 overflow-y-auto border p-2 rounded-md"></div></div>
                            <div class="flex items-center space-x-4 pt-4 border-t"><button type="submit" id="berita-submit-button" class="btn btn-red w-full">Simpan Berita</button><button type="button" id="berita-cancel-edit-button" class="btn btn-gray hidden">Batal</button></div>
                        </form>
                    </div>
                    <div class="lg:col-span-2 bg-white rounded-lg shadow-md">
                        <div class="p-6 border-b"><h2 class="text-xl font-bold">Daftar Berita</h2></div>
                        <div id="berita-list-container" class="p-6 space-y-4"></div>
                    </div>
                </div>
            `;
        }

        async function fetchBerita() {
            const listContainer = document.getElementById('berita-list-container');
            listContainer.innerHTML = '<p class="text-center text-gray-500">Memuat berita...</p>';
            const { data, error } = await supabase.from('berita').select('*, berita_tags(tags(name))').order('tanggal', { ascending: false });
            if (error) return listContainer.innerHTML = '<p class="text-center text-red-500">Gagal memuat berita.</p>';
            
            listContainer.innerHTML = '';
            data.forEach(item => {
                const tagsHTML = item.berita_tags.map(bt => `<span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded-full">${bt.tags.name}</span>`).join(' ');
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex items-start space-x-4 p-4 border rounded-lg hover:bg-gray-50';
                itemDiv.innerHTML = `
                    <img src="${item.gambar_url || 'https://placehold.co/100x100/EFEFEF/AAAAAA?text=N/A'}" class="w-24 h-24 object-cover rounded-md flex-shrink-0">
                    <div class="flex-grow">
                        <p class="text-sm text-gray-500">${new Date(item.tanggal).toLocaleDateString('id-ID')}</p>
                        <h3 class="font-bold text-lg text-gray-800">${item.judul}</h3>
                        <div class="mt-2 flex flex-wrap gap-2">${tagsHTML}</div>
                    </div>
                    <div class="flex-shrink-0 space-x-2">
                        <button class="text-green-600 hover:text-green-900" onclick="editBerita(${item.id})">Edit</button>
                        <button class="text-red-600 hover:text-red-900" onclick="deleteBerita(${item.id})">Hapus</button>
                    </div>
                `;
                listContainer.appendChild(itemDiv);
            });
        }

        function setupBeritaLogic() {
            const form = document.getElementById('berita-form');
            const formCard = document.getElementById('berita-form-card');
            const formTitle = document.getElementById('berita-form-title');
            const submitButton = document.getElementById('berita-submit-button');
            const cancelBtn = document.getElementById('berita-cancel-edit-button');
            const gambarUpload = document.getElementById('berita-gambar-upload');
            const gambarPreview = document.getElementById('berita-gambar-preview');
            const idInput = document.getElementById('berita-id');
            const existingGambarUrlInput = document.getElementById('berita-existing-gambar-url');

            const resetForm = () => {
                form.reset();
                idInput.value = '';
                existingGambarUrlInput.value = '';
                gambarPreview.src = 'https://placehold.co/600x400/EFEFEF/AAAAAA?text=Gambar';
                formTitle.innerText = 'Tambah Berita Baru';
                submitButton.innerText = 'Simpan Berita';
                submitButton.classList.replace('btn-green', 'btn-red');
                formCard.classList.remove('bg-green-50');
                cancelBtn.classList.add('hidden');
                document.querySelectorAll('#berita-tags-checkbox-container input[type="checkbox"]').forEach(cb => cb.checked = false);
            };

            window.editBerita = async (id) => {
                const { data, error } = await supabase.from('berita').select('*, berita_tags(tag_id)').eq('id', id).single();
                if (error) return showNotification("Gagal mengambil data berita", "error");
                
                resetForm();
                formTitle.innerText = 'Edit Berita';
                submitButton.innerText = 'Update Berita';
                submitButton.classList.replace('btn-red', 'btn-green');
                formCard.classList.add('bg-green-50');

                idInput.value = data.id;
                existingGambarUrlInput.value = data.gambar_url || '';
                gambarPreview.src = data.gambar_url || 'https://placehold.co/600x400/EFEFEF/AAAAAA?text=Gambar';
                document.getElementById('berita-judul').value = data.judul || '';
                document.getElementById('berita-tanggal').value = data.tanggal || '';
                document.getElementById('berita-isi').value = data.isi || '';
                
                const selectedTagIds = data.berita_tags.map(bt => bt.tag_id);
                document.querySelectorAll('#berita-tags-checkbox-container input[type="checkbox"]').forEach(cb => {
                    cb.checked = selectedTagIds.includes(parseInt(cb.value));
                });

                cancelBtn.classList.remove('hidden');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            window.deleteBerita = async (id) => {
                if (!confirm('Yakin ingin menghapus berita ini?')) return;
                const { data, error } = await supabase.from('berita').delete().eq('id', id).select().single();
                if (error) return showNotification(`Gagal menghapus: ${error.message}`, 'error');

                if (data && data.gambar_url) {
                    const path = new URL(data.gambar_url).pathname.split('/gambar-berita/')[1];
                    await supabase.storage.from('gambar-berita').remove([path]);
                }
                showNotification('Berita berhasil dihapus.', 'success');
                fetchBerita();
            };

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = idInput.value;
                submitButton.disabled = true;
                submitButton.textContent = 'Menyimpan...';

                let gambarUrl = existingGambarUrlInput.value;
                const file = gambarUpload.files[0];

                if (file) {
                    const fileName = `berita/${Date.now()}-${file.name}`;
                    const { error: uploadError } = await supabase.storage.from('gambar-berita').upload(fileName, file);
                    if (uploadError) {
                        showNotification(`Gagal unggah gambar: ${uploadError.message}`, 'error');
                        submitButton.disabled = false;
                        submitButton.textContent = id ? 'Update Berita' : 'Simpan Berita';
                        return;
                    }
                    const { data: urlData } = supabase.storage.from('gambar-berita').getPublicUrl(fileName);
                    gambarUrl = urlData.publicUrl;
                }

                const beritaData = {
                    judul: document.getElementById('berita-judul').value,
                    tanggal: document.getElementById('berita-tanggal').value,
                    isi: document.getElementById('berita-isi').value,
                    gambar_url: gambarUrl,
                };
                
                const selectedTagIds = Array.from(document.querySelectorAll('#berita-tags-checkbox-container input:checked')).map(cb => parseInt(cb.value));

                if (id) {
                    const { error } = await supabase.from('berita').update(beritaData).eq('id', id);
                    if (error) return showNotification(`Gagal update berita: ${error.message}`, 'error');
                    
                    await supabase.from('berita_tags').delete().eq('berita_id', id);
                    if (selectedTagIds.length > 0) {
                        const tagsToInsert = selectedTagIds.map(tag_id => ({ berita_id: id, tag_id }));
                        await supabase.from('berita_tags').insert(tagsToInsert);
                    }
                    showNotification('Berita berhasil diupdate!', 'success');
                } else {
                    const { data, error } = await supabase.from('berita').insert([beritaData]).select().single();
                    if (error) return showNotification(`Gagal simpan berita: ${error.message}`, 'error');
                    
                    if (selectedTagIds.length > 0) {
                        const tagsToInsert = selectedTagIds.map(tag_id => ({ berita_id: data.id, tag_id }));
                        await supabase.from('berita_tags').insert(tagsToInsert);
                    }
                    showNotification('Berita berhasil disimpan!', 'success');
                }
                
                resetForm();
                fetchBerita();
                submitButton.disabled = false;
                submitButton.textContent = id ? 'Update Berita' : 'Simpan Berita';
            });

            cancelBtn.addEventListener('click', resetForm);
            gambarUpload.addEventListener('change', (e) => { if (e.target.files[0]) gambarPreview.src = URL.createObjectURL(e.target.files[0]); });
        }

        // --- PROYEK PANEL ---
        function renderProyekPanel() {
            document.getElementById('panel-proyek').innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-md">
                        <h2 id="proyek-form-title" class="text-xl font-bold mb-4">Tambah Proyek Baru</h2>
                        <form id="proyek-form" class="space-y-6">
                            <input type="hidden" id="proyek-id"><input type="hidden" id="proyek-existing-gambar-url">
                            <div><label class="form-label">Gambar Proyek</label><div class="mt-1"><img id="proyek-gambar-preview" src="https://placehold.co/600x400/EFEFEF/AAAAAA?text=Gambar" class="w-full h-40 object-cover bg-gray-100 rounded"><input type="file" id="proyek-gambar-upload" accept="image/*" class="hidden"><button type="button" onclick="document.getElementById('proyek-gambar-upload').click()" class="mt-2 btn bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 w-full">Pilih Gambar</button></div></div>
                            <div><label for="proyek-judul" class="form-label">Judul Proyek</label><input type="text" id="proyek-judul" class="form-input" required></div>
                            <div><label for="proyek-tanggal" class="form-label">Tanggal Proyek</label><input type="date" id="proyek-tanggal" class="form-input" required></div>
                            <div><label for="proyek-kategori" class="form-label">Kategori</label><select id="proyek-kategori" class="form-input"><option>Internasional</option><option>Nasional</option><option>Unggulan</option></select></div>
                            <div><label for="proyek-deskripsi" class="form-label">Deskripsi Singkat</label><textarea id="proyek-deskripsi" rows="4" class="form-input"></textarea></div>
                            <div class="flex items-center space-x-4 pt-4 border-t"><button type="submit" id="proyek-submit-button" class="btn btn-red w-full">Simpan Proyek</button><button type="button" id="proyek-cancel-edit-button" class="btn btn-gray hidden">Batal</button></div>
                        </form>
                    </div>
                    <div class="lg:col-span-2 bg-white rounded-lg shadow-md">
                        <div class="p-6 border-b"><h2 class="text-xl font-bold">Daftar Proyek</h2></div>
                        <div id="proyek-list-container" class="p-6 space-y-4"></div>
                    </div>
                </div>
            `;
        }

        async function fetchProyek() {
            const listContainer = document.getElementById('proyek-list-container');
            listContainer.innerHTML = '<p class="text-center text-gray-500">Memuat proyek...</p>';
            const { data, error } = await supabase.from('projects').select('*').order('created_at', { ascending: false });
            if (error) return listContainer.innerHTML = '<p class="text-center text-red-500">Gagal memuat proyek.</p>';
            
            listContainer.innerHTML = '';
            data.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex items-start space-x-4 p-4 border rounded-lg hover:bg-gray-50';
                itemDiv.innerHTML = `
                    <img src="${item.gambar_url || 'https://placehold.co/100x100/EFEFEF/AAAAAA?text=N/A'}" class="w-24 h-24 object-cover rounded-md flex-shrink-0">
                    <div class="flex-grow">
                        <p class="text-sm text-gray-500">${new Date(item.tanggal).toLocaleDateString('id-ID')}</p>
                        <h3 class="font-bold text-lg text-gray-800">${item.judul}</h3>
                        <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">${item.kategori}</span>
                    </div>
                    <div class="flex-shrink-0 space-x-2">
                        <button class="text-green-600 hover:text-green-900" onclick="editProyek(${item.id})">Edit</button>
                        <button class="text-red-600 hover:text-red-900" onclick="deleteProyek(${item.id})">Hapus</button>
                    </div>
                `;
                listContainer.appendChild(itemDiv);
            });
        }

        function setupProyekLogic() {
            const form = document.getElementById('proyek-form');
            const formCard = document.getElementById('proyek-form-card');
            const formTitle = document.getElementById('proyek-form-title');
            const submitButton = document.getElementById('proyek-submit-button');
            const cancelBtn = document.getElementById('proyek-cancel-edit-button');
            const gambarUpload = document.getElementById('proyek-gambar-upload');
            const gambarPreview = document.getElementById('proyek-gambar-preview');
            const idInput = document.getElementById('proyek-id');
            const existingGambarUrlInput = document.getElementById('proyek-existing-gambar-url');

            const resetForm = () => {
                form.reset();
                idInput.value = '';
                existingGambarUrlInput.value = '';
                gambarPreview.src = 'https://placehold.co/600x400/EFEFEF/AAAAAA?text=Gambar';
                formTitle.innerText = 'Tambah Proyek Baru';
                submitButton.innerText = 'Simpan Proyek';
                submitButton.classList.replace('btn-green', 'btn-red');
                formCard.classList.remove('bg-green-50');
                cancelBtn.classList.add('hidden');
            };

            window.editProyek = async (id) => {
                const { data, error } = await supabase.from('projects').select('*').eq('id', id).single();
                if (error) return showNotification("Gagal mengambil data proyek", "error");
                
                resetForm();
                formTitle.innerText = 'Edit Proyek';
                submitButton.innerText = 'Update Proyek';
                submitButton.classList.replace('btn-red', 'btn-green');
                formCard.classList.add('bg-green-50');

                idInput.value = data.id;
                existingGambarUrlInput.value = data.gambar_url || '';
                gambarPreview.src = data.gambar_url || 'https://placehold.co/600x400/EFEFEF/AAAAAA?text=Gambar';
                document.getElementById('proyek-judul').value = data.judul || '';
                document.getElementById('proyek-tanggal').value = data.tanggal || '';
                document.getElementById('proyek-kategori').value = data.kategori || 'Unggulan';
                document.getElementById('proyek-deskripsi').value = data.deskripsi || '';

                cancelBtn.classList.remove('hidden');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            window.deleteProyek = async (id) => {
                if (!confirm('Yakin ingin menghapus proyek ini?')) return;
                const { data, error } = await supabase.from('projects').delete().eq('id', id).select().single();
                if (error) return showNotification(`Gagal menghapus: ${error.message}`, 'error');

                if (data && data.gambar_url) {
                    const path = new URL(data.gambar_url).pathname.split('/gambar-proyek/')[1];
                    await supabase.storage.from('gambar-proyek').remove([path]);
                }
                showNotification('Proyek berhasil dihapus.', 'success');
                fetchProyek();
            };

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = idInput.value;
                submitButton.disabled = true;
                submitButton.textContent = 'Menyimpan...';

                let gambarUrl = existingGambarUrlInput.value;
                const file = gambarUpload.files[0];

                if (file) {
                    const fileName = `proyek/${Date.now()}-${file.name}`;
                    const { error: uploadError } = await supabase.storage.from('gambar-proyek').upload(fileName, file);
                    if (uploadError) {
                        showNotification(`Gagal unggah gambar: ${uploadError.message}`, 'error');
                        submitButton.disabled = false;
                        submitButton.textContent = id ? 'Update Proyek' : 'Simpan Proyek';
                        return;
                    }
                    const { data: urlData } = supabase.storage.from('gambar-proyek').getPublicUrl(fileName);
                    gambarUrl = urlData.publicUrl;
                }

                const proyekData = {
                    judul: document.getElementById('proyek-judul').value,
                    tanggal: document.getElementById('proyek-tanggal').value,
                    kategori: document.getElementById('proyek-kategori').value,
                    deskripsi: document.getElementById('proyek-deskripsi').value,
                    gambar_url: gambarUrl,
                };
                
                const { error } = id ? await supabase.from('projects').update(proyekData).eq('id', id) : await supabase.from('projects').insert([proyekData]);
                if (error) showNotification(`Gagal simpan proyek: ${error.message}`, 'error');
                else {
                    showNotification('Proyek berhasil disimpan!', 'success');
                    resetForm();
                    fetchProyek();
                }
                submitButton.disabled = false;
                submitButton.textContent = id ? 'Update Proyek' : 'Simpan Proyek';
            });

            cancelBtn.addEventListener('click', resetForm);
            gambarUpload.addEventListener('change', (e) => { if (e.target.files[0]) gambarPreview.src = URL.createObjectURL(e.target.files[0]); });
        }

        // --- TAGS PANEL ---
        function renderTagsPanel() {
            document.getElementById('panel-tags').innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-bold mb-4">Tambah Tag Baru</h2>
                        <form id="tag-form" class="flex items-center space-x-4">
                            <input type="hidden" id="tag-id">
                            <input type="text" id="tag-name" class="form-input" placeholder="Nama tag..." required>
                            <button type="submit" id="tag-submit-button" class="btn btn-red">Simpan</button>
                            <button type="button" id="tag-cancel-button" class="btn btn-gray hidden">Batal</button>
                        </form>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-bold mb-4">Daftar Tags</h2>
                        <div id="tags-list" class="space-y-2"></div>
                    </div>
                </div>
            `;
        }
        
        async function fetchTags() {
            const { data, error } = await supabase.from('tags').select('*').order('name');
            if (error) return;

            const listContainer = document.getElementById('tags-list');
            listContainer.innerHTML = '';
            data.forEach(tag => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-2 border-b';
                div.innerHTML = `
                    <span>${tag.name}</span>
                    <div class="space-x-2">
                        <button class="text-sm text-green-600" onclick="editTag(${tag.id}, '${tag.name}')">Edit</button>
                        <button class="text-sm text-red-600" onclick="deleteTag(${tag.id})">Hapus</button>
                    </div>
                `;
                listContainer.appendChild(div);
            });

            const checkboxContainer = document.getElementById('berita-tags-checkbox-container');
            if (checkboxContainer) {
                checkboxContainer.innerHTML = '';
                data.forEach(tag => {
                    const label = document.createElement('label');
                    label.className = 'flex items-center space-x-2';
                    label.innerHTML = `<input type="checkbox" value="${tag.id}" class="rounded border-gray-300 text-red-600 shadow-sm focus:border-red-300 focus:ring focus:ring-red-200 focus:ring-opacity-50"><span>${tag.name}</span>`;
                    checkboxContainer.appendChild(label);
                });
            }
        }

        function setupTagsLogic() {
            const form = document.getElementById('tag-form');
            const idInput = document.getElementById('tag-id');
            const nameInput = document.getElementById('tag-name');
            const submitButton = document.getElementById('tag-submit-button');
            const cancelBtn = document.getElementById('tag-cancel-button');

            const resetForm = () => {
                form.reset();
                idInput.value = '';
                submitButton.textContent = 'Simpan';
                cancelBtn.classList.add('hidden');
            };

            window.editTag = (id, name) => {
                idInput.value = id;
                nameInput.value = name;
                submitButton.textContent = 'Update';
                cancelBtn.classList.remove('hidden');
                nameInput.focus();
            };

            window.deleteTag = async (id) => {
                if (!confirm('Yakin ingin menghapus tag ini? Ini akan menghapus tag dari semua berita terkait.')) return;
                const { error } = await supabase.from('tags').delete().eq('id', id);
                if (error) showNotification(`Gagal hapus tag: ${error.message}`, 'error');
                else {
                    showNotification('Tag berhasil dihapus.', 'success');
                    fetchTags();
                }
            };

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = idInput.value;
                const name = nameInput.value;
                if (!name) return;

                const data = { name };
                const { error } = id ? await supabase.from('tags').update(data).eq('id', id) : await supabase.from('tags').insert(data);

                if (error) showNotification(`Gagal simpan tag: ${error.message}`, 'error');
                else {
                    showNotification('Tag berhasil disimpan!', 'success');
                    resetForm();
                    fetchTags();
                }
            });

            cancelBtn.addEventListener('click', resetForm);
        }

    </script>
</body>
</html>
